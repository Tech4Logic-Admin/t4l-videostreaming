services:
  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: t4l-postgres
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: t4l_videosearch
    volumes:
      - pgdata:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql:ro
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - t4l-network

  # Azurite - Azure Storage Emulator
  azurite:
    image: mcr.microsoft.com/azure-storage/azurite
    container_name: t4l-azurite
    command: "azurite --blobHost 0.0.0.0 --queueHost 0.0.0.0 --tableHost 0.0.0.0 --loose"
    volumes:
      - azurite-data:/data
    ports:
      - "10000:10000"  # Blob
      - "10001:10001"  # Queue
      - "10002:10002"  # Table
    networks:
      - t4l-network

  # ASP.NET Core API
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: t4l-api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=t4l_videosearch;Username=postgres;Password=postgres
      - BlobStorage__ConnectionString=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
      - FeatureFlags__UseDevAuth=true
      - FeatureFlags__UseMockVideoIndexer=true
      - FeatureFlags__UseMockContentSafety=true
      - FeatureFlags__UseMockSearch=true
      - Cors__AllowedOrigins=http://localhost:3000
    ports:
      - "5000:8080"
    depends_on:
      postgres:
        condition: service_healthy
      azurite:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/healthz"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - t4l-network

  # Next.js Frontend
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: t4l-web
    environment:
      - NODE_ENV=production
      - API_URL=http://api:8080
    ports:
      - "3000:3000"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - t4l-network

  # Azure Functions Worker (optional for local dev - can be run separately)
  # worker:
  #   build:
  #     context: ./apps/worker
  #     dockerfile: Dockerfile
  #   container_name: t4l-worker
  #   environment:
  #     - AzureWebJobsStorage=DefaultEndpointsProtocol=http;AccountName=devstoreaccount1;AccountKey=Eby8vdM02xNOcqFlqUwJPLlmEtlCDXJ1OUzFT50uSRZ6IFsuFq2UVErCz4I6tq/K1SZFPTOtr/KBHBeksoGMGw==;BlobEndpoint=http://azurite:10000/devstoreaccount1;QueueEndpoint=http://azurite:10001/devstoreaccount1;TableEndpoint=http://azurite:10002/devstoreaccount1;
  #     - ConnectionStrings__DefaultConnection=Host=postgres;Port=5432;Database=t4l_videosearch;Username=postgres;Password=postgres
  #     - FeatureFlags__UseMockVideoIndexer=true
  #     - FeatureFlags__UseMockContentSafety=true
  #     - FeatureFlags__UseMockSearch=true
  #   depends_on:
  #     - postgres
  #     - azurite
  #   networks:
  #     - t4l-network

volumes:
  pgdata:
  azurite-data:

networks:
  t4l-network:
    driver: bridge
